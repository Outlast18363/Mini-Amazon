{% extends "base.html" %}
{% block content %}
<h2>My Reviews</h2>

<h3>Write a Review (from your recent orders)</h3>
{% if purchasables %}
<table class="table">
  <thead>
    <tr><th>Product</th><th>Seller</th><th>Actions</th></tr>
  </thead>
  <tbody id="purchasablesTable">
    {% for x in purchasables %}
      <tr class="purchasable-row" style="display: {% if loop.index <= 5 %}table-row{% else %}none{% endif %};">
        <td><a href="/products/{{ x.product_id }}">{{ x.product_name }}</a></td>
        <td>
          <a href="{{ url_for('users.public_profile', user_id=x.seller_profile_user_id) }}">
            {{ x.seller_name }}
          </a>
        </td>
        <td>
          <button class="btn btn-sm btn-outline-primary"
                  onclick="newProductReview({{ x.product_id }})">Review product</button>
          <button class="btn btn-sm btn-outline-primary"
                  onclick="newSellerReview({{ x.seller_user_id }})">Review seller</button>
        </td>
      </tr>
    {% endfor %}
  </tbody>
</table>
{% if purchasables|length > 5 %}
<div style="text-align: center; margin-top: 10px;">
  <a href="javascript:void(0)" id="purchasablesShowMore" onclick="showMore('purchasables')" style="text-decoration: underline; cursor: pointer;">Show 10 more</a>
  <a href="javascript:void(0)" id="purchasablesShowLess" onclick="showLess('purchasables')" style="text-decoration: underline; cursor: pointer; display: none;">Show less</a>
</div>
{% endif %}
{% else %}
<p>No recent purchases found.</p>
{% endif %}

<h3>Product Reviews</h3>
{% if product_reviews %}
<table class="table">
  <thead>
    <tr>
      <th>Product</th><th>Rating</th><th>Title</th><th>Helpful</th><th>Updated</th><th>Actions</th>
    </tr>
  </thead>
  <tbody id="productReviewsTable">
  {% for r in product_reviews %}
    <tr class="product-review-row" data-review-id="{{ r.review_id }}" data-product-id="{{ r.product_id }}" style="display: {% if loop.index <= 5 %}table-row{% else %}none{% endif %};">
      <td><a href="/products/{{ r.product_id }}">{{ r.product_name }}</a></td>
      <td>{{ r.rating }}</td>
      <td>{{ r.title or "" }}</td>
      <td>{{ r.helpful_count }}</td>
      <td>{{ r.updated_at }}</td>
      <td>
        <button class="btn btn-sm btn-primary edit-product-review" 
                data-product-id="{{ r.product_id }}"
                data-rating="{{ r.rating }}"
                data-title="{{ r.title or '' }}"
                data-body="{{ r.body or '' }}">Edit</button>
        <button class="btn btn-sm btn-danger delete-product-review" 
                data-product-id="{{ r.product_id }}">Delete</button>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% if product_reviews|length > 5 %}
<div style="text-align: center; margin-top: 10px;">
  <a href="javascript:void(0)" id="productReviewsShowMore" onclick="showMore('productReviews')" style="text-decoration: underline; cursor: pointer;">Show 10 more</a>
  <a href="javascript:void(0)" id="productReviewsShowLess" onclick="showLess('productReviews')" style="text-decoration: underline; cursor: pointer; display: none;">Show less</a>
</div>
{% endif %}
{% else %}
<p>No product reviews yet.</p>
{% endif %}

<h3>Seller Reviews</h3>
{% if seller_reviews %}
<table class="table">
  <thead>
    <tr>
      <th>Seller</th><th>Rating</th><th>Title</th><th>Updated</th><th>Actions</th>
    </tr>
  </thead>
  <tbody id="sellerReviewsTable">
  {% for r in seller_reviews %}
    <tr class="seller-review-row" data-review-id="{{ r.review_id }}" data-seller-id="{{ r.seller_user_id }}" style="display: {% if loop.index <= 5 %}table-row{% else %}none{% endif %};">
      <td>
        <a href="{{ url_for('users.public_profile', user_id=r.seller_profile_user_id) }}">
          {{ r.seller_name }}
        </a>
      </td>
      <td>{{ r.rating }}</td>
      <td>{{ r.title or "" }}</td>
      <td>{{ r.updated_at }}</td>
      <td>
        <button class="btn btn-sm btn-primary edit-seller-review" 
                data-seller-id="{{ r.seller_user_id }}"
                data-rating="{{ r.rating }}"
                data-title="{{ r.title or '' }}"
                data-body="{{ r.body or '' }}">Edit</button>
        <button class="btn btn-sm btn-danger delete-seller-review" 
                data-seller-id="{{ r.seller_user_id }}">Delete</button>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
{% if seller_reviews|length > 5 %}
<div style="text-align: center; margin-top: 10px;">
  <a href="javascript:void(0)" id="sellerReviewsShowMore" onclick="showMore('sellerReviews')" style="text-decoration: underline; cursor: pointer;">Show 10 more</a>
  <a href="javascript:void(0)" id="sellerReviewsShowLess" onclick="showLess('sellerReviews')" style="text-decoration: underline; cursor: pointer; display: none;">Show less</a>
</div>
{% endif %}
{% else %}
<p>No seller reviews yet.</p>
{% endif %}

<!-- Modal for editing/creating reviews -->
<div id="reviewModal" style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); 
     background:white; padding:20px; border:2px solid #ccc; z-index:9999; min-width:400px; border-radius:8px;">
  <h4 id="modalTitle">Review</h4>
  <div id="reviewErrorAlert" class="alert alert-danger" role="alert" style="display:none; margin-bottom:15px;"></div>
  <form id="reviewForm">
    <div style="margin-bottom:10px;">
      <label>Rating (1-5): <span style="color:red;">*</span></label>
      <input type="number" id="reviewRating" min="1" max="5" required style="width:100%; padding:5px;">
    </div>
    <div style="margin-bottom:10px;">
      <label>Title (optional):</label>
      <input type="text" id="reviewTitle" style="width:100%; padding:5px;">
    </div>
    <div style="margin-bottom:10px;">
      <label>Review: <span style="color:red;">*</span></label>
      <textarea id="reviewBody" rows="4" required style="width:100%; padding:5px;"></textarea>
    </div>
    <button type="submit" class="btn btn-primary">Save</button>
    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
    <button type="button" id="deleteBtn" class="btn btn-danger" style="display:none;" onclick="deleteCurrentReview()">Delete Review</button>
  </form>
</div>
<div id="modalOverlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; 
     background:rgba(0,0,0,0.5); z-index:9998;" onclick="closeModal()"></div>

<script>
let currentReviewType = null;
let currentId = null;
let isEditing = false;

function closeModal() {
  document.getElementById('reviewModal').style.display = 'none';
  document.getElementById('modalOverlay').style.display = 'none';
}

function openModal(type, id, rating, title, body) {
  currentReviewType = type;
  currentId = id;
  isEditing = (rating !== null && rating !== undefined);
  
  const modalTitle = isEditing 
    ? (type === 'product' ? 'Edit Product Review' : 'Edit Seller Review')
    : (type === 'product' ? 'Write Product Review' : 'Write Seller Review');
  
  document.getElementById('modalTitle').textContent = modalTitle;
  document.getElementById('reviewRating').value = rating || 5;
  document.getElementById('reviewTitle').value = title || '';
  document.getElementById('reviewBody').value = body || '';
  
  // Hide error alert when opening modal
  document.getElementById('reviewErrorAlert').style.display = 'none';
  
  // Show delete button only when editing
  document.getElementById('deleteBtn').style.display = isEditing ? 'inline-block' : 'none';
  
  document.getElementById('reviewModal').style.display = 'block';
  document.getElementById('modalOverlay').style.display = 'block';
}

function deleteCurrentReview() {
  if (!confirm('Are you sure you want to delete this review?')) return;
  
  const url = currentReviewType === 'product' 
    ? `/api/reviews/product/${currentId}/delete`
    : `/api/reviews/seller/${currentId}/delete`;
  
  fetch(url, { method: 'POST' })
    .then(resp => resp.json())
    .then(data => {
      if (data.ok) {
        alert('Review deleted!');
        location.reload();
      } else {
        alert('Error: ' + (data.error || 'Unknown error'));
      }
    })
    .catch(err => alert('Network error: ' + err.message));
  
  closeModal();
}

document.getElementById('reviewForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  // Hide previous error
  const errorAlert = document.getElementById('reviewErrorAlert');
  errorAlert.style.display = 'none';
  
  const rating = parseInt(document.getElementById('reviewRating').value);
  const title = document.getElementById('reviewTitle').value.trim();
  const body = document.getElementById('reviewBody').value.trim();
  
  // Validation
  if (!body) {
    alert('Please write a review. The review text is required.');
    return;
  }
  
  if (!rating || rating < 1 || rating > 5) {
    alert('Please provide a rating between 1 and 5.');
    return;
  }
  
  const url = currentReviewType === 'product' 
    ? `/api/reviews/product/${currentId}`
    : `/api/reviews/seller/${currentId}`;
  
  try {
    const resp = await fetch(url, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({rating, title, body})
    });
    const data = await resp.json();
    if (data.ok) {
      alert('Review saved!');
      location.reload();
    } else {
      // Show error in red alert box
      errorAlert.textContent = data.error || 'Unknown error';
      errorAlert.style.display = 'block';
    }
  } catch (err) {
    errorAlert.textContent = 'Network error: ' + err.message;
    errorAlert.style.display = 'block';
  }
});

// Create new product review (from purchasables)
function newProductReview(productId) {
  openModal('product', productId, null, '', '');
}

// Create new seller review (from purchasables)
function newSellerReview(sellerId) {
  openModal('seller', sellerId, null, '', '');
}

// Edit product review
document.querySelectorAll('.edit-product-review').forEach(btn => {
  btn.addEventListener('click', () => {
    const productId = btn.dataset.productId;
    const rating = btn.dataset.rating;
    const title = btn.dataset.title;
    const body = btn.dataset.body;
    openModal('product', productId, rating, title, body);
  });
});

// Delete product review
document.querySelectorAll('.delete-product-review').forEach(btn => {
  btn.addEventListener('click', async () => {
    if (!confirm('Delete this product review?')) return;
    const productId = btn.dataset.productId;
    try {
      const resp = await fetch(`/api/reviews/product/${productId}/delete`, {
        method: 'POST'
      });
      const data = await resp.json();
      if (data.ok) {
        alert('Review deleted!');
        location.reload();
      }
    } catch (err) {
      alert('Error: ' + err.message);
    }
  });
});

// Edit seller review
document.querySelectorAll('.edit-seller-review').forEach(btn => {
  btn.addEventListener('click', () => {
    const sellerId = btn.dataset.sellerId;
    const rating = btn.dataset.rating;
    const title = btn.dataset.title;
    const body = btn.dataset.body;
    openModal('seller', sellerId, rating, title, body);
  });
});

// Delete seller review
document.querySelectorAll('.delete-seller-review').forEach(btn => {
  btn.addEventListener('click', async () => {
    if (!confirm('Delete this seller review?')) return;
    const sellerId = btn.dataset.sellerId;
    try {
      const resp = await fetch(`/api/reviews/seller/${sellerId}/delete`, {
        method: 'POST'
      });
      const data = await resp.json();
      if (data.ok) {
        alert('Review deleted!');
        location.reload();
      }
    } catch (err) {
      alert('Error: ' + err.message);
    }
  });
});

// Show more/show less functionality
const visibleCounts = {
  purchasables: 5,
  productReviews: 5,
  sellerReviews: 5
};

function showMore(section) {
  const className = section === 'purchasables' ? 'purchasable-row' : 
                    section === 'productReviews' ? 'product-review-row' : 
                    'seller-review-row';
  const rows = document.querySelectorAll(`.${className}`);
  const currentVisible = visibleCounts[section];
  const newVisible = Math.min(currentVisible + 10, rows.length);
  
  for (let i = 0; i < newVisible; i++) {
    rows[i].style.display = 'table-row';
  }
  
  visibleCounts[section] = newVisible;
  
  // Update button text
  const remaining = rows.length - newVisible;
  const showMoreBtn = document.getElementById(`${section}ShowMore`);
  const showLessBtn = document.getElementById(`${section}ShowLess`);
  
  if (remaining > 0) {
    showMoreBtn.textContent = `Show ${Math.min(10, remaining)} more`;
  } else {
    showMoreBtn.style.display = 'none';
  }
  
  showLessBtn.style.display = 'inline';
}

function showLess(section) {
  const className = section === 'purchasables' ? 'purchasable-row' : 
                    section === 'productReviews' ? 'product-review-row' : 
                    'seller-review-row';
  const rows = document.querySelectorAll(`.${className}`);
  
  // Hide all except first 5
  for (let i = 5; i < rows.length; i++) {
    rows[i].style.display = 'none';
  }
  
  visibleCounts[section] = 5;
  
  // Update buttons
  const showMoreBtn = document.getElementById(`${section}ShowMore`);
  const showLessBtn = document.getElementById(`${section}ShowLess`);
  const remaining = rows.length - 5;
  
  showMoreBtn.textContent = `Show ${Math.min(10, remaining)} more`;
  showMoreBtn.style.display = 'inline';
  showLessBtn.style.display = 'none';
}
</script>
{% endblock %}



