{% extends "base.html" %}
{% block content %}
<h2>Your Orders</h2>

<form method="GET" style="margin-bottom: 1rem; padding: 0.5rem; border: 1px solid #ccc;">
  <div style="margin-bottom: 0.5rem;">
    <label>Keyword in item name:</label>
    <input type="text" name="q" value="{{ q }}">
  </div>

  <div style="margin-bottom: 0.5rem;">
    <label>Seller ID:</label>
    <input type="text" name="seller" value="{{ seller }}" placeholder="e.g. 2">
  </div>

  <div style="margin-bottom: 0.5rem;">
    <label>Start date (YYYY-MM-DD):</label>
    <input type="text" name="start" value="{{ start_date }}" placeholder="2025-10-01">
  </div>

  <div style="margin-bottom: 0.5rem;">
    <label>End date (YYYY-MM-DD):</label>
    <input type="text" name="end" value="{{ end_date }}" placeholder="2025-10-31">
  </div>

  <div style="margin-bottom: 0.5rem;">
    <label>Orders per page:</label>
    <select name="limit" onchange="this.form.submit()">
      <option value="10" {% if limit == 10 %}selected{% endif %}>10</option>
      <option value="20" {% if limit == 20 %}selected{% endif %}>20</option>
      <option value="50" {% if limit == 50 %}selected{% endif %}>50</option>
      <option value="100" {% if limit == 100 %}selected{% endif %}>100</option>
    </select>
    <input type="hidden" name="offset" value="0"> 
  </div>

  <button type="submit">Filter</button>
</form>

{% if orders|length == 0 %}
  <p>No orders found.</p>
  {% if offset > 0 %}
    <a href="{{ url_for('users.orders', limit=limit, offset=offset-limit, q=q, seller=seller, start=start_date, end=end_date) }}">Go Back</a>
  {% endif %}
{% else %}
  
  {% for order in orders %}
  <div class="card mb-3">
    <div class="card-header d-flex justify-content-between align-items-center">
      <div>
        <strong>Order #{{ order.id }}</strong>
        <span class="text-muted mx-2">|</span>
        {{ order.placed_at.strftime('%Y-%m-%d %H:%M:%S') }}
        <span class="text-muted mx-2">|</span>
        Status: {{ order.status }}
      </div>
      <div class="text-right">
        <strong>Total: ${{ '%.2f'|format(order.total_cents / 100.0) }}</strong>
        {% if order.balance_after_cents is not none %}
          <br><small class="text-muted">Balance After: ${{ '%.2f'|format(order.balance_after_cents / 100.0) }}</small>
        {% endif %}
        <a href="{{ url_for('orders.detail', order_id=order.id) }}" class="btn btn-sm btn-outline-primary ml-2">Details</a>
      </div>
    </div>
    <div class="card-body p-0">
      <table class="table table-sm table-hover mb-0">
        <thead class="thead-light">
          <tr>
            <th width="40%">Product</th>
            <th width="20%">Seller</th>
            <th width="10%" class="text-right">Quantity</th>
            <th width="15%" class="text-right">Unit Price</th>
            <th width="15%" class="text-right">Total</th>
          </tr>
        </thead>
        <tbody>
          {% for item in order.line_items %}
          <tr>
            <td>
              <a href="{{ url_for('products.detail', product_id=item.product_id) }}">
                {{ item.product_name }}
              </a>
            </td>
            <td>
              <a href="{{ url_for('users.public_profile', user_id=item.seller_user_id) }}">
                {{ item.seller_name }}
              </a>
            </td>
            <td class="text-right">{{ item.quantity }}</td>
            <td class="text-right">${{ '%.2f'|format(item.price_cents / 100.0) }}</td>
            <td class="text-right">${{ '%.2f'|format(item.total_cents / 100.0) }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endfor %}

  <div style="margin-top: 1rem;">
    {% if offset > 0 %}
      <a href="{{ url_for('users.orders', limit=limit, offset=offset-limit, q=q, seller=seller, start=start_date, end=end_date) }}">
        &laquo; Previous Page
      </a>
    {% else %}
      <span style="color: gray;">&laquo; Previous Page</span>
    {% endif %}

    <span style="margin: 0 1rem;">
      Page {{ (offset // limit) + 1 }}
    </span>

    {% if orders|length == limit %}
      <a href="{{ url_for('users.orders', limit=limit, offset=offset+limit, q=q, seller=seller, start=start_date, end=end_date) }}">
        Next Page &raquo;
      </a>
    {% else %}
      <span style="color: gray;">Next Page &raquo;</span>
    {% endif %}
  </div>
{% endif %}

{% endblock %}