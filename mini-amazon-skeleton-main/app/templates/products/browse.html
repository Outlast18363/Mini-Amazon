{% extends "base.html" %}

{% block content %}

{% if current_user.is_authenticated %}
<div class="mb-3 mt-3">
  <a href="{{ url_for('products.create') }}" class="btn btn-black">
    Create New Product
  </a>
</div>
{% endif %}

<h2>Products for Purchase:</h2>
<!-- Search, Filter, Sort, Limit Buttons -->
<form method="get" class="form-inline mb-3">
<label class="mr-2" for="category">Category:</label>
<select name="category" id="category" class="form-control mr-3">
  <option value="">All</option>
  {% for category in categories %}
    <option value="{{ category.id }}" {% if request.args.get('category')|int == category.id %}selected{% endif %}>
      {{ category.name }}
    </option>
  {% endfor %}
</select>

  <label class="mr-2" for="search">Search:</label>
  <input type="text" name="search" id="search" class="form-control mr-3" 
         value="{{ request.args.get('search', '') }}" placeholder="Search name or description">

  <label class="mr-2" for="sort">Sort by:</label>
  <select name="sort" id="sort" class="form-control mr-3">
    <option value="">Name</option>
    <option value="price_asc" {% if request.args.get('sort') == 'price_asc' %}selected{% endif %}>Price ↑</option>
    <option value="price_desc" {% if request.args.get('sort') == 'price_desc' %}selected{% endif %}>Price ↓</option>
  </select>

  <label class="mr-2" for="limit">Limit:</label>
  <input type="number" name="limit" id="limit" class="form-control mr-3" 
         value="{{ request.args.get('limit', '') }}" placeholder="Max results">

  <button type="submit" class="btn btn-black">Apply</button>
</form>

<!-- Products Table -->
<div class="row">
  <div class="col-12 mb-3">
    <h3>Featured Products</h3>
  </div>

  {% if products %}
    {% for product in products %}
    <div class="col-md-4 col-lg-3 mb-4">
      <div class="card h-100 shadow-sm">
        <img
          src="{{ product.image_url or 'https://via.placeholder.com/300x200?text=No+Image' }}"
          class="card-img-top"
          alt="{{ product.name }}"
          style="height: 200px; object-fit: cover;"
        >

        <div class="card-body d-flex flex-column">
          <h5 class="card-title text-truncate" title="{{ product.name }}"> {{ product.name }} </h5>
          
          <p class="card-text text-muted mb-1"> Category: {{ product.category_name if product.category_name else 'Uncategorized' }} </p>

          <p class="card-text text-muted mb-1">
            Price:
            {% if product.avg_price %}
              ${{ '%.2f' % product.avg_price }}
            {% else %}
              No sellers yet
            {% endif %}
          </p>

          <p class="card-text text-muted mb-1">
            Rating:
            {% if product.review_count and product.review_count > 0 %}
              {{ '%.1f' % product.avg_rating }} stars ({{ product.review_count }} reviews)
            {% else %}
              No reviews yet
            {% endif %}
          </p>

          <a href="{{ url_for('products.detail', product_id=product.id) }}"
            class="btn btn-outline-primary mt-auto btn-block">
            View Details
          </a>
        </div>
      </div>
    </div>
    {% endfor %}
  {% else %}
    <div class="col-12">
      <p>No products available at the moment.</p>
    </div>
  {% endif %}
</div>

<!-- Pagination Controls -->
<form method="get" class="form-inline mt-3">
  <!-- Preserve filters (hidden inputs) -->
  <input type="hidden" name="category" value="{{ request.args.get('category') or '' }}">
  <input type="hidden" name="search" value="{{ request.args.get('search') or '' }}">
  <input type="hidden" name="sort" value="{{ request.args.get('sort') or '' }}">
  <input type="hidden" name="limit" value="{{ request.args.get('limit') or '' }}">

  <label for="page" class="mr-2">Page:</label>
  <select name="page" id="page" class="form-control mr-3" onchange="this.form.submit()">
    {% for p in range(1, total_pages + 1) %}
      <option value="{{ p }}" {% if p == current_page %}selected{% endif %}>
        {{ p }} {% if p == current_page %}(current){% endif %}
      </option>
    {% endfor %}
  </select>

  <span>of {{ total_pages }}</span>
</form>

{% endblock %}
